name: ounwan-nest-docker-image
on:
  push:
    branches: 
      - "main"
      - "dev"

jobs:

  checkout:
    runs-on: [self-hosted, ounwan-nest-runner]
    steps:
      - name: ğŸ›’ Checkout        
        id: checkout
        uses: actions/checkout@v4





  build_start:
    needs: checkout
    if: contains(github.event.head_commit.message, '[skip]') != true
    runs-on: [self-hosted, ounwan-nest-runner]
    steps:
      - name: ğŸš€ build_start
        run: 
          echo "> ë¹Œë“œ ì‹œì‘"




  dev_build:
    needs: build_start
    if: github.ref == 'refs/heads/dev'    
    runs-on: [self-hosted, ounwan-nest-runner]
    steps:
      - name: ğŸš€ dev_docker_build_start
        run: |
          sudo docker-compose -f dockerDev-compose.yml up -d --build







  current_port_check:
    needs: build_start
    if: github.ref == 'refs/heads/main'
    runs-on: [self-hosted, ounwan-nest-runner]
    outputs:
      port_output: ${{ steps.output.outputs.port_output }}
    steps:
      - id: output
        name: ğŸ‘“ site_document_check
        env:
          BLUE_PORT: ${{ secrets.BLUE_PORT }}
        run: |
          is_blue_document=$(curl -s http://localhost:$BLUE_PORT/health | grep "UP" | wc -l)
          if [ $is_blue_document -ge 1 ]
          then
              echo "port_output=green_start" >> $GITHUB_OUTPUT
          else
              echo "port_output=blue_start" >> $GITHUB_OUTPUT
          fi 

  
  docker_green_build:
    needs: current_port_check
    if: ${{needs.current_port_check.outputs.port_output == 'green_start'}}
    runs-on: [self-hosted, ounwan-nest-runner]
    steps:
      - name: ğŸ’š ğŸš€ green_start
        run: |
          sudo docker-compose -f docker-compose-green.yml up --renew-anon-volumes -d --build


  docker_blue_build:
      needs: current_port_check
      if: ${{needs.current_port_check.outputs.port_output == 'blue_start'}}
      runs-on: [self-hosted, ounwan-nest-runner]
      steps:
        - name: ğŸ’™ ğŸš€ blue_start
          run: |
            sudo docker-compose -f docker-compose-blue.yml up --renew-anon-volumes -d --build
  





  green_build_success:
    needs: docker_green_build
    runs-on: [self-hosted, ounwan-nest-runner]
    steps:
      - name: ğŸ’š âœ… green_build_success
        env:
          GREEN_PORT: ${{ secrets.GREEN_PORT }}
          RESTORE_PORT: ${{ secrets.RESTORE_PORT }}
        run: |
          for retry_count in {1..5}
          do
            is_green_document=$(curl -s http://localhost:$GREEN_PORT/health | grep "UP" | wc -l)
            if [ $is_green_document -ge 1 ]
            then
                echo "> ê·¸ë¦°í¬íŠ¸ Document í™•ì¸ ì™„ë£Œ"

                echo "> ì—”ì§„ì—‘ìŠ¤ ë¸”ë£¨í¬íŠ¸ -> ê·¸ë¦°í¬íŠ¸ í¬íŠ¸ì „í™˜ ì‹œì‘"
                echo "set \$service_url http://127.0.0.1:$GREEN_PORT;" |sudo tee /etc/nginx/conf.d/ounwan-nest-url.inc
                echo "> í¬íŠ¸ì „í™˜ì™„ë£Œ"

                echo "> ì—”ì§„ì—‘ìŠ¤ ì¬ì‹œì‘"
                sudo nginx -s reload
                echo "> ì‚¬ì´íŠ¸ ë°°í¬ ì™„ë£Œ"
                
                
            
                echo "> ë°±ì—… ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œì‘"
                docker commit ounwan-nest-blue ounwan-nest-copy
                sleep 3

                echo "> ë°±ì—… ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ì¤‘ì¸ ê²½ìš° ì‚­ì œ"
                if docker ps -a | grep -q ounwan-nest-backup; then
                    echo "> ë°±ì—… ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œí•©ë‹ˆë‹¤..."
                    sudo docker rm -f ounwan-nest-backup
                fi
                
                sleep 3
                echo "> ê·¸ë¦°í¬íŠ¸ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ì¤‘ ì´ë¯€ë¡œ ë¸”ë£¨í¬íŠ¸ ì¤‘ë‹¨"
                sudo docker stop ounwan-nest-blue
                sleep 3
                docker run -d -p $RESTORE_PORT:40000 --name ounwan-nest-backup ounwan-nest-copy
                sleep 3
                sudo docker rm ounwan-nest-blue
                sleep 3
                break
            else
                echo "> ê·¸ë¦° Document ì°¾ì„ ìˆ˜ ì—†ìŒ...."
            fi

            if [ $retry_count -eq 5 ]
            then
              echo "> ê·¸ë¦°í¬íŠ¸ ë¹Œë“œ ì‹¤íŒ¨!!!"
              echo "> ë°°í¬ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤..."
              exit 1
            fi
            echo "> ê·¸ë¦° Document ì—°ê²° ì‹¤íŒ¨ ì¬ì‹œë„"
          done







          
  blue_build_success:
    needs: docker_blue_build
    runs-on: [self-hosted, ounwan-nest-runner]
    steps:
      - name: ğŸ’™ âœ… blue_build_success
        env:
          BLUE_PORT: ${{ secrets.BLUE_PORT }}
          RESTORE_PORT: ${{ secrets.RESTORE_PORT }}
        run: |
          for retry_count in {1..5}
          do
            is_blue_document=$(curl -s http://localhost:$BLUE_PORT/health | grep "UP" | wc -l)
            if [ $is_blue_document -ge 1 ]
            then
                echo "> ë¸”ë£¨í¬íŠ¸ Document í™•ì¸ ì™„ë£Œ"

                echo "> ì—”ì§„ì—‘ìŠ¤ ê·¸ë¦°í¬íŠ¸ -> ë¸”ë£¨í¬íŠ¸ í¬íŠ¸ì „í™˜ ì‹œì‘"
                echo "set \$service_url http://127.0.0.1:$BLUE_PORT;" |sudo tee /etc/nginx/conf.d/ounwan-nest-url.inc
                echo "> í¬íŠ¸ì „í™˜ì™„ë£Œ"

                echo "> ì—”ì§„ì—‘ìŠ¤ ì¬ì‹œì‘"
                sudo nginx -s reload
                echo "> ì‚¬ì´íŠ¸ ë°°í¬ ì™„ë£Œ"
            
            
            
                echo "> ë°±ì—… ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œì‘"
                docker commit ounwan-nest-green ounwan-nest-copy
                sleep 3
                echo "> ë¸”ë£¨í¬íŠ¸ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ì¤‘ ì´ë¯€ë¡œ ê·¸ë¦°í¬íŠ¸ ì¤‘ë‹¨"
                sudo docker stop ounwan-nest-green
                sleep 3

                echo "> ë°±ì—… ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ì¤‘ì¸ ê²½ìš° ì‚­ì œ"
                if docker ps -a | grep -q ounwan-nest-backup; then
                    echo "> ë°±ì—… ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œí•©ë‹ˆë‹¤..."
                    sudo docker rm -f ounwan-nest-backup
                fi
                
                sleep 3
                docker run -d -p $RESTORE_PORT:40000 --name ounwan-nest-backup ounwan-nest-copy
                sleep 3
                sudo docker rm ounwan-nest-green
                sleep 3

                break
            else
                echo "> ë¸”ë£¨ Document ì°¾ì„ ìˆ˜ ì—†ìŒ...."
            fi

            if [ $retry_count -eq 5 ]
            then
              echo "> ë¸”ë£¨í¬íŠ¸ ë¹Œë“œ ì‹¤íŒ¨!!!"
              echo "> ë°°í¬ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤..."
              exit 1
            fi
            echo "> ë¸”ë£¨ Document ì—°ê²° ì‹¤íŒ¨ ì¬ì‹œë„"
          done




  old_image_prune:
    if: ${{ always() }}
    needs: [blue_build_success, green_build_success]
    runs-on: [self-hosted, ounwan-nest-runner]
    steps:
      - name: âŒ Prune Old Images
        run: sudo docker image prune -f



  all_actions_success:
    needs: [old_image_prune]
    runs-on: [self-hosted, ounwan-nest-runner]
    steps:
      - name: ğŸ‰ All Actions Successful
        run: echo "CI/CD action workflow have been successfully completed!"